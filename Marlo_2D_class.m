classdef Marlo_2D_class <handle
    properties
        H0=[0, 0, 0, 0, 0, 0, 0, .5, .5,  0,  0;...
            0, 0, 0, 0, 0, 0, 0,  0,  0, .5, .5;...
            0, 0, 0, 0, 0, 0, 0, -1,  1,  0,  0;...
            0, 0, 0, 0, 0, 0, 0,  0,  0, -1,  1];
        c =[0, 0, -1, -.5, -.5, 0, 0, 0, 0, 0, 0];
%         c =[0, 0, -1,0, 0, 0, 0, -.5, -.5, 0,  0];
        
        g=9.81; %m/s^2
        
        %Leg data
        L1=0.45; %m
        L2=0.5;
        L3=0.5;
        L4=0.5;
        
        m1=0.66149; %kg Maybe four bar linkage (0.6460 in PowerPoint)
        m2=0.68292;
        m3=0.19126;
        m4=0.42493; % Probably lower leg
        
        % Hip data  %%Note that in the planar modoel, the torso and hip are a
        % single unit
        mH = 2*12.84; %kg Mass of Hip
        
        % Torso Data
        LT=0.8; %m
        mT=34.83; %kg Mass of Torso
        % Hip Data
        W=0.165; %m
        
        Jcm1 =0.0228; % kg m^2 Lxx of shin (L1)
        Jcm2 = 0.031; % thigh (L2)
        Jcm3 = 0.0176; % Lxx from four bar linkage.
        Jcm4 = 0.01260;
        
        ellzcm1 = 0.1435; %m shin (L1)
        ellzcm2 = 0.1822; % Z from thigh. (L2)
        ellzcm3 = 0.1137; % Z from Four bar linkage. (L3)
        ellzcm4 = 0.15203; % Z from Lower leg. (L4)
        ellycm1 = -0.0253; % Y from shin. (L1)
        ellycm2 = 0.0157; % Y from thigh. (L2)
        ellycm3 = 0;
        ellycm4 = 0;
        
        % Torso Data
        
        % see [g mTotal m1 m2 m3 m4 mT L1 L2 L3 L4 LT W mH] =  modelParametersAtriasMassLength
        % for mass distribution of torso
        ellzcmT  = 0.6046;
        %ellzcmT  = 0.3;
        ellycmT = 0.0181;
        JcmT = 1.73;
        JcmH=2*0.10791;
        
        %Motor and Gear Reducers
        R1=50;
        R2=50;
        Jgear1 = 2.85377e-3; % kg m^2 SHOULD be the Harmonic Drive Inertia......Current, it is the nominal value from MABEL step down pulley
        Jgear2=2.85377e-3;
        Jrotor1= 7e-4; % kg m^2
        Jrotor2=7e-4;
        
%         KJonathan = 1200.0; % N-m/rad.
        KJonathan = 1200;
        Kspring = 50;
        Zeta=.4;
        Kfric_HarmonicDrive = 0*3.2868e+000;
    end
    properties (Dependent)
        mTotal;
        K1;
        K2;
        Kd1;
        Kd2;
    end
    methods
        function [g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ...
                ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT ...
                JcmT  ellzcmT ellycmT K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 Jgear1  ...
                Jgear2 R1  R2]=get_parameters(obj)
            
            para_vect=[ obj.g obj.mTotal obj.L1 obj.L2 obj.L3 obj.L4 obj.m1 obj.m2 obj.m3 obj.m4 obj.Jcm1 obj.Jcm2 obj.Jcm3 obj.Jcm4 obj.ellzcm1 ...
                obj.ellzcm2 obj.ellzcm3 obj.ellzcm4 obj.ellycm1 obj.ellycm2 obj.ellycm3 obj.ellycm4 obj.LT obj.mT ...
                obj.JcmT obj.ellzcmT obj.ellycmT obj.K1 obj.K2 obj.Kd1 obj.Kd2 obj.Jrotor1 obj.Jrotor2 obj.Jgear1  ...
                obj.Jgear2 obj.R1 obj.R2];
            para_vect=num2cell(para_vect);
            [g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ...
                ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT ...
                JcmT  ellzcmT ellycmT K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 Jgear1  ...
                Jgear2 R1  R2]=para_vect{:};
        end
        function [D,C,G,B,DampingSpringTorque]= Dynamic_model(obj,q,dq)
            [g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ...
                ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT ...
                JcmT  ellzcmT ellycmT K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 Jgear1  ...
                Jgear2 R1  R2] = obj.get_parameters;
            
            yLeg=q(1);	dyLeg=dq(1);
            zLeg=q(2);  dzLeg=dq(2);
            qT=q(3);	dqT=dq(3);
            q1=q(4);	dq1=dq(4);
            q2=q(5);	dq2=dq(5);
            q1L=q(6);	dq1L=dq(6);
            q2L=q(7);	dq2L=dq(7);
            qgr1=q(8);  dqgr1=dq(8);
            qgr2=q(9);  dqgr2=dq(9);
            qgr1L=q(10);dqgr1L=dq(10);
            qgr2L=q(11);dqgr2L=dq(11);
            %%%%
            %%%%
            D=zeros(11,11);
            D(1,1)=2*m1 + 2*m2 + 2*m3 + 2*m4 + mT;
            D(1,3)=2*L2*m1*cos(q2 + qT) - ellycmT*mT*sin(qT) - L1*m3*...
                cos(q1 + qT) - ellzcmT*mT*cos(qT) + 2*L2*m2*cos(q2 + qT) + 2*L4*...
                m1*cos(q1 + qT) + 2*L2*m3*cos(q2 + qT) + 2*L4*m2*...
                cos(q1 + qT) + L2*m4*cos(q2 + qT) + 2*L4*m3*cos(q1 + qT) + 2*L4*...
                m4*cos(q1 + qT) - L1*m3*cos(q1L + qT) - L2*m4*cos(q2L + qT) + L2*...
                mT*cos(q2 + qT) + L4*mT*cos(q1 + qT) - ellzcm1*m1*...
                cos(q1 + qT) - ellzcm2*m2*cos(q2 + qT) - ellzcm3*m3*...
                cos(q2 + qT) - ellzcm4*m4*cos(q1 + qT) - ellzcm1*m1*...
                cos(q1L + qT) - ellzcm2*m2*cos(q2L + qT) - ellzcm3*m3*...
                cos(q2L + qT) - ellzcm4*m4*cos(q1L + qT) - ellycm1*m1*...
                sin(q1 + qT) - ellycm2*m2*sin(q2 + qT) - ellycm3*m3*...
                sin(q2 + qT) - ellycm4*m4*sin(q1 + qT) - ellycm1*m1*...
                sin(q1L + qT) - ellycm2*m2*sin(q2L + qT) - ellycm3*m3*...
                sin(q2L + qT) - ellycm4*m4*sin(q1L + qT);
            D(1,4)=2*L4*m1*cos(q1 + qT) - L1*m3*cos(q1 + qT) + 2*L4*m2*...
                cos(q1 + qT) + 2*L4*m3*cos(q1 + qT) + 2*L4*m4*cos(q1 + qT) + L4*...
                mT*cos(q1 + qT) - ellzcm1*m1*cos(q1 + qT) - ellzcm4*m4*...
                cos(q1 + qT) - ellycm1*m1*sin(q1 + qT) - ellycm4*m4*sin(q1 + qT);
            D(1,5)=2*L2*m1*cos(q2 + qT) + 2*L2*m2*cos(q2 + qT) + 2*L2*m3*...
                cos(q2 + qT) + L2*m4*cos(q2 + qT) + L2*mT*cos(q2 + qT) - ellzcm2*...
                m2*cos(q2 + qT) - ellzcm3*m3*cos(q2 + qT) - ellycm2*m2*...
                sin(q2 + qT) - ellycm3*m3*sin(q2 + qT);
            D(1,6)=- (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
                sin(q1L + qT)))/2 - (m4*(2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
                sin(q1L + qT)))/2 - L1*m3*cos(q1L + qT);
            D(1,7)=- (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
                sin(q2L + qT)))/2 - (m3*(2*ellzcm3*cos(q2L + qT) + 2*ellycm3*...
                sin(q2L + qT)))/2 - L2*m4*cos(q2L + qT);
            D(2,2)=2*m1 + 2*m2 + 2*m3 + 2*m4 + mT;
            D(2,3)=ellycmT*mT*cos(qT) - ellzcmT*mT*sin(qT) - L1*m3*...
                sin(q1 + qT) + 2*L2*m1*sin(q2 + qT) + 2*L2*m2*sin(q2 + qT) + 2*...
                L4*m1*sin(q1 + qT) + 2*L2*m3*sin(q2 + qT) + 2*L4*m2*...
                sin(q1 + qT) + L2*m4*sin(q2 + qT) + 2*L4*m3*sin(q1 + qT) + 2*L4*...
                m4*sin(q1 + qT) - L1*m3*sin(q1L + qT) - L2*m4*sin(q2L + qT) + L2*...
                mT*sin(q2 + qT) + L4*mT*sin(q1 + qT) + ellycm1*m1*...
                cos(q1 + qT) + ellycm2*m2*cos(q2 + qT) + ellycm3*m3*...
                cos(q2 + qT) + ellycm4*m4*cos(q1 + qT) + ellycm1*m1*...
                cos(q1L + qT) + ellycm2*m2*cos(q2L + qT) + ellycm3*m3*...
                cos(q2L + qT) + ellycm4*m4*cos(q1L + qT) - ellzcm1*m1*...
                sin(q1 + qT) - ellzcm2*m2*sin(q2 + qT) - ellzcm3*m3*...
                sin(q2 + qT) - ellzcm4*m4*sin(q1 + qT) - ellzcm1*m1*...
                sin(q1L + qT) - ellzcm2*m2*sin(q2L + qT) - ellzcm3*m3*...
                sin(q2L + qT) - ellzcm4*m4*sin(q1L + qT);
            D(2,4)=2*L4*m1*sin(q1 + qT) - L1*m3*sin(q1 + qT) + 2*L4*m2*...
                sin(q1 + qT) + 2*L4*m3*sin(q1 + qT) + 2*L4*m4*sin(q1 + qT) + L4*...
                mT*sin(q1 + qT) + ellycm1*m1*cos(q1 + qT) + ellycm4*m4*...
                cos(q1 + qT) - ellzcm1*m1*sin(q1 + qT) - ellzcm4*m4*sin(q1 + qT);
            D(2,5)=2*L2*m1*sin(q2 + qT) + 2*L2*m2*sin(q2 + qT) + 2*L2*m3*...
                sin(q2 + qT) + L2*m4*sin(q2 + qT) + L2*mT*sin(q2 + qT) + ellycm2*...
                m2*cos(q2 + qT) + ellycm3*m3*cos(q2 + qT) - ellzcm2*m2*...
                sin(q2 + qT) - ellzcm3*m3*sin(q2 + qT);
            D(2,6)=(m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
                sin(q1L + qT)))/2 + (m4*(2*ellycm4*cos(q1L + qT) - 2*ellzcm4*...
                sin(q1L + qT)))/2 - L1*m3*sin(q1L + qT);
            D(2,7)=(m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
                sin(q2L + qT)))/2 + (m3*(2*ellycm3*cos(q2L + qT) - 2*ellzcm3*...
                sin(q2L + qT)))/2 - L2*m4*sin(q2L + qT);
            D(3,1)=2*L2*m1*cos(q2 + qT) - ellycmT*mT*sin(qT) - L1*m3*...
                cos(q1 + qT) - ellzcmT*mT*cos(qT) + 2*L2*m2*cos(q2 + qT) + 2*L4*...
                m1*cos(q1 + qT) + 2*L2*m3*cos(q2 + qT) + 2*L4*m2*...
                cos(q1 + qT) + L2*m4*cos(q2 + qT) + 2*L4*m3*cos(q1 + qT) + 2*L4*...
                m4*cos(q1 + qT) - L1*m3*cos(q1L + qT) - L2*m4*cos(q2L + qT) + L2*...
                mT*cos(q2 + qT) + L4*mT*cos(q1 + qT) - ellzcm1*m1*...
                cos(q1 + qT) - ellzcm2*m2*cos(q2 + qT) - ellzcm3*m3*...
                cos(q2 + qT) - ellzcm4*m4*cos(q1 + qT) - ellzcm1*m1*...
                cos(q1L + qT) - ellzcm2*m2*cos(q2L + qT) - ellzcm3*m3*...
                cos(q2L + qT) - ellzcm4*m4*cos(q1L + qT) - ellycm1*m1*...
                sin(q1 + qT) - ellycm2*m2*sin(q2 + qT) - ellycm3*m3*...
                sin(q2 + qT) - ellycm4*m4*sin(q1 + qT) - ellycm1*m1*...
                sin(q1L + qT) - ellycm2*m2*sin(q2L + qT) - ellycm3*m3*...
                sin(q2L + qT) - ellycm4*m4*sin(q1L + qT);
            D(3,2)=ellycmT*mT*cos(qT) - ellzcmT*mT*sin(qT) - L1*m3*...
                sin(q1 + qT) + 2*L2*m1*sin(q2 + qT) + 2*L2*m2*sin(q2 + qT) + 2*...
                L4*m1*sin(q1 + qT) + 2*L2*m3*sin(q2 + qT) + 2*L4*m2*...
                sin(q1 + qT) + L2*m4*sin(q2 + qT) + 2*L4*m3*sin(q1 + qT) + 2*L4*...
                m4*sin(q1 + qT) - L1*m3*sin(q1L + qT) - L2*m4*sin(q2L + qT) + L2*...
                mT*sin(q2 + qT) + L4*mT*sin(q1 + qT) + ellycm1*m1*...
                cos(q1 + qT) + ellycm2*m2*cos(q2 + qT) + ellycm3*m3*...
                cos(q2 + qT) + ellycm4*m4*cos(q1 + qT) + ellycm1*m1*...
                cos(q1L + qT) + ellycm2*m2*cos(q2L + qT) + ellycm3*m3*...
                cos(q2L + qT) + ellycm4*m4*cos(q1L + qT) - ellzcm1*m1*...
                sin(q1 + qT) - ellzcm2*m2*sin(q2 + qT) - ellzcm3*m3*...
                sin(q2 + qT) - ellzcm4*m4*sin(q1 + qT) - ellzcm1*m1*...
                sin(q1L + qT) - ellzcm2*m2*sin(q2L + qT) - ellzcm3*m3*...
                sin(q2L + qT) - ellzcm4*m4*sin(q1L + qT);
            D(3,3)=2*Jcm1 + 2*Jcm2 + 2*Jcm3 + 2*Jcm4 + JcmT + 2*Jgear1 + 2*...
                Jgear2 + 2*Jrotor1 + 2*Jrotor2 + 2*L2^2*m1 + 2*L1^2*m3 + 2*L2^2*...
                m2 + 2*L2^2*m3 + 2*L4^2*m1 + 2*L2^2*m4 + 2*L4^2*m2 + 2*L4^2*...
                m3 + 2*L4^2*m4 + L2^2*mT + L4^2*mT + 2*ellycm1^2*m1 + 2*...
                ellzcm1^2*m1 + 2*ellycm2^2*m2 + 2*ellzcm2^2*m2 + 2*ellycm3^2*...
                m3 + 2*ellzcm3^2*m3 + 2*ellycm4^2*m4 + 2*ellzcm4^2*...
                m4 + ellycmT^2*mT + ellzcmT^2*mT - 2*L1*L4*m3 - 2*L2^2*m4*...
                cos(q2 - q2L) - 2*L2*ellzcm2*m2 - 2*L4*ellzcm1*m1 - 2*L2*ellzcm3*...
                m3 - 2*L4*ellzcm4*m4 - 2*L2*ellzcmT*mT*cos(q2) - 2*L4*ellzcmT*mT*...
                cos(q1) + 2*L2*ellycmT*mT*sin(q2) + 2*L4*ellycmT*mT*sin(q1) - 2*...
                L1*L2*m3*cos(q1 - q2) + 4*L2*L4*m1*cos(q1 - q2) + 4*L2*L4*m2*...
                cos(q1 - q2) + 4*L2*L4*m3*cos(q1 - q2) + 2*L2*L4*m4*...
                cos(q1 - q2) - 2*L1*L2*m3*cos(q2 - q1L) - 2*L1*L4*m3*...
                cos(q1 - q1L) - 2*L2*L4*m4*cos(q1 - q2L) + 2*L2*L4*mT*...
                cos(q1 - q2) - 2*L2*ellzcm1*m1*cos(q1 - q2) + 2*L1*ellzcm3*m3*...
                cos(q1 - q2) - 2*L4*ellzcm2*m2*cos(q1 - q2) - 2*L4*ellzcm3*m3*...
                cos(q1 - q2) - 2*L2*ellzcm1*m1*cos(q2 - q1L) - 2*L4*ellzcm1*m1*...
                cos(q1 - q1L) - 2*L2*ellzcm2*m2*cos(q2 - q2L) - 2*L4*ellzcm2*m2*...
                cos(q1 - q2L) - 2*L2*ellzcm3*m3*cos(q2 - q2L) - 2*L2*ellzcm4*m4*...
                cos(q2 - q1L) - 2*L4*ellzcm3*m3*cos(q1 - q2L) - 2*L4*ellzcm4*m4*...
                cos(q1 - q1L) + 2*L1*ellzcm3*m3*cos(q1L - q2L) + 2*L2*ellzcm4*m4*...
                cos(q1L - q2L) - 2*L2*ellycm1*m1*sin(q1 - q2) - 2*L1*ellycm3*m3*...
                sin(q1 - q2) + 2*L4*ellycm2*m2*sin(q1 - q2) + 2*L4*ellycm3*m3*...
                sin(q1 - q2) + 2*L2*ellycm1*m1*sin(q2 - q1L) + 2*L4*ellycm1*m1*...
                sin(q1 - q1L) + 2*L2*ellycm2*m2*sin(q2 - q2L) + 2*L4*ellycm2*m2*...
                sin(q1 - q2L) + 2*L2*ellycm3*m3*sin(q2 - q2L) + 2*L2*ellycm4*m4*...
                sin(q2 - q1L) + 2*L4*ellycm3*m3*sin(q1 - q2L) + 2*L4*ellycm4*m4*...
                sin(q1 - q1L) - 2*L1*ellycm3*m3*sin(q1L - q2L) + 2*L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(3,4)=Jcm1 + Jcm4 + L1^2*m3 + 2*L4^2*m1 + 2*L4^2*m2 + 2*L4^2*...
                m3 + 2*L4^2*m4 + L4^2*mT + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 - 2*L1*L4*m3 - 2*L4*ellzcm1*...
                m1 - 2*L4*ellzcm4*m4 - L4*ellzcmT*mT*cos(q1) + L4*ellycmT*mT*...
                sin(q1) - L1*L2*m3*cos(q1 - q2) + 2*L2*L4*m1*cos(q1 - q2) + 2*L2*...
                L4*m2*cos(q1 - q2) + 2*L2*L4*m3*cos(q1 - q2) + L2*L4*m4*...
                cos(q1 - q2) - L1*L4*m3*cos(q1 - q1L) - L2*L4*m4*...
                cos(q1 - q2L) + L2*L4*mT*cos(q1 - q2) - L2*ellzcm1*m1*...
                cos(q1 - q2) + L1*ellzcm3*m3*cos(q1 - q2) - L4*ellzcm2*m2*...
                cos(q1 - q2) - L4*ellzcm3*m3*cos(q1 - q2) - L4*ellzcm1*m1*...
                cos(q1 - q1L) - L4*ellzcm2*m2*cos(q1 - q2L) - L4*ellzcm3*m3*...
                cos(q1 - q2L) - L4*ellzcm4*m4*cos(q1 - q1L) - L2*ellycm1*m1*...
                sin(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L4*ellycm2*m2*...
                sin(q1 - q2) + L4*ellycm3*m3*sin(q1 - q2) + L4*ellycm1*m1*...
                sin(q1 - q1L) + L4*ellycm2*m2*sin(q1 - q2L) + L4*ellycm3*m3*...
                sin(q1 - q2L) + L4*ellycm4*m4*sin(q1 - q1L);
            D(3,5)=Jcm2 + Jcm3 + 2*L2^2*m1 + 2*L2^2*m2 + 2*L2^2*m3 + L2^2*...
                m4 + L2^2*mT + ellycm2^2*m2 + ellzcm2^2*m2 + ellycm3^2*...
                m3 + ellzcm3^2*m3 - L2^2*m4*cos(q2 - q2L) - 2*L2*ellzcm2*m2 - 2*...
                L2*ellzcm3*m3 - L2*ellzcmT*mT*cos(q2) + L2*ellycmT*mT*...
                sin(q2) - L1*L2*m3*cos(q1 - q2) + 2*L2*L4*m1*cos(q1 - q2) + 2*L2*...
                L4*m2*cos(q1 - q2) + 2*L2*L4*m3*cos(q1 - q2) + L2*L4*m4*...
                cos(q1 - q2) - L1*L2*m3*cos(q2 - q1L) + L2*L4*mT*...
                cos(q1 - q2) - L2*ellzcm1*m1*cos(q1 - q2) + L1*ellzcm3*m3*...
                cos(q1 - q2) - L4*ellzcm2*m2*cos(q1 - q2) - L4*ellzcm3*m3*...
                cos(q1 - q2) - L2*ellzcm1*m1*cos(q2 - q1L) - L2*ellzcm2*m2*...
                cos(q2 - q2L) - L2*ellzcm3*m3*cos(q2 - q2L) - L2*ellzcm4*m4*...
                cos(q2 - q1L) - L2*ellycm1*m1*sin(q1 - q2) - L1*ellycm3*m3*...
                sin(q1 - q2) + L4*ellycm2*m2*sin(q1 - q2) + L4*ellycm3*m3*...
                sin(q1 - q2) + L2*ellycm1*m1*sin(q2 - q1L) + L2*ellycm2*m2*...
                sin(q2 - q2L) + L2*ellycm3*m3*sin(q2 - q2L) + L2*ellycm4*m4*...
                sin(q2 - q1L);
            D(3,6)=Jcm1 + Jcm4 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 - L1*L2*m3*cos(q2 - q1L) - L1*...
                L4*m3*cos(q1 - q1L) - L2*ellzcm1*m1*cos(q2 - q1L) - L4*ellzcm1*...
                m1*cos(q1 - q1L) - L2*ellzcm4*m4*cos(q2 - q1L) - L4*ellzcm4*m4*...
                cos(q1 - q1L) + L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
                cos(q1L - q2L) + L2*ellycm1*m1*sin(q2 - q1L) + L4*ellycm1*m1*...
                sin(q1 - q1L) + L2*ellycm4*m4*sin(q2 - q1L) + L4*ellycm4*m4*...
                sin(q1 - q1L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(3,7)=Jcm2 + Jcm3 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
                m2 + ellycm3^2*m3 + ellzcm3^2*m3 - L2^2*m4*cos(q2 - q2L) - L2*L4*...
                m4*cos(q1 - q2L) - L2*ellzcm2*m2*cos(q2 - q2L) - L4*ellzcm2*m2*...
                cos(q1 - q2L) - L2*ellzcm3*m3*cos(q2 - q2L) - L4*ellzcm3*m3*...
                cos(q1 - q2L) + L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
                cos(q1L - q2L) + L2*ellycm2*m2*sin(q2 - q2L) + L4*ellycm2*m2*...
                sin(q1 - q2L) + L2*ellycm3*m3*sin(q2 - q2L) + L4*ellycm3*m3*...
                sin(q1 - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(3,8)=Jgear1 + Jrotor1*R1;
            D(3,9)=Jgear2 + Jrotor2*R2;
            D(3,10)=Jgear1 + Jrotor1*R1;
            D(3,11)=Jgear2 + Jrotor2*R2;
            D(4,1)=2*L4*m1*cos(q1 + qT) - L1*m3*cos(q1 + qT) + 2*L4*m2*...
                cos(q1 + qT) + 2*L4*m3*cos(q1 + qT) + 2*L4*m4*cos(q1 + qT) + L4*...
                mT*cos(q1 + qT) - ellzcm1*m1*cos(q1 + qT) - ellzcm4*m4*...
                cos(q1 + qT) - ellycm1*m1*sin(q1 + qT) - ellycm4*m4*sin(q1 + qT);
            D(4,2)=2*L4*m1*sin(q1 + qT) - L1*m3*sin(q1 + qT) + 2*L4*m2*...
                sin(q1 + qT) + 2*L4*m3*sin(q1 + qT) + 2*L4*m4*sin(q1 + qT) + L4*...
                mT*sin(q1 + qT) + ellycm1*m1*cos(q1 + qT) + ellycm4*m4*...
                cos(q1 + qT) - ellzcm1*m1*sin(q1 + qT) - ellzcm4*m4*sin(q1 + qT);
            D(4,3)=Jcm1 + Jcm4 + L1^2*m3 + 2*L4^2*m1 + 2*L4^2*m2 + 2*L4^2*...
                m3 + 2*L4^2*m4 + L4^2*mT + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 - 2*L1*L4*m3 - 2*L4*ellzcm1*...
                m1 - 2*L4*ellzcm4*m4 - L4*ellzcmT*mT*cos(q1) + L4*ellycmT*mT*...
                sin(q1) - L1*L2*m3*cos(q1 - q2) + 2*L2*L4*m1*cos(q1 - q2) + 2*L2*...
                L4*m2*cos(q1 - q2) + 2*L2*L4*m3*cos(q1 - q2) + L2*L4*m4*...
                cos(q1 - q2) - L1*L4*m3*cos(q1 - q1L) - L2*L4*m4*...
                cos(q1 - q2L) + L2*L4*mT*cos(q1 - q2) - L2*ellzcm1*m1*...
                cos(q1 - q2) + L1*ellzcm3*m3*cos(q1 - q2) - L4*ellzcm2*m2*...
                cos(q1 - q2) - L4*ellzcm3*m3*cos(q1 - q2) - L4*ellzcm1*m1*...
                cos(q1 - q1L) - L4*ellzcm2*m2*cos(q1 - q2L) - L4*ellzcm3*m3*...
                cos(q1 - q2L) - L4*ellzcm4*m4*cos(q1 - q1L) - L2*ellycm1*m1*...
                sin(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L4*ellycm2*m2*...
                sin(q1 - q2) + L4*ellycm3*m3*sin(q1 - q2) + L4*ellycm1*m1*...
                sin(q1 - q1L) + L4*ellycm2*m2*sin(q1 - q2L) + L4*ellycm3*m3*...
                sin(q1 - q2L) + L4*ellycm4*m4*sin(q1 - q1L);
            D(4,4)=Jcm1 + Jcm4 + L1^2*m3 + 2*L4^2*m1 + 2*L4^2*m2 + 2*L4^2*...
                m3 + 2*L4^2*m4 + L4^2*mT + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 - 2*L1*L4*m3 - 2*L4*ellzcm1*...
                m1 - 2*L4*ellzcm4*m4;
            D(4,5)=2*L2*L4*m1*cos(q1 - q2) - L1*L2*m3*cos(q1 - q2) + 2*L2*L4*...
                m2*cos(q1 - q2) + 2*L2*L4*m3*cos(q1 - q2) + L2*L4*m4*...
                cos(q1 - q2) + L2*L4*mT*cos(q1 - q2) - L2*ellzcm1*m1*...
                cos(q1 - q2) + L1*ellzcm3*m3*cos(q1 - q2) - L4*ellzcm2*m2*...
                cos(q1 - q2) - L4*ellzcm3*m3*cos(q1 - q2) - L2*ellycm1*m1*...
                sin(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L4*ellycm2*m2*...
                sin(q1 - q2) + L4*ellycm3*m3*sin(q1 - q2);
            D(4,6)=-L4*(L1*m3*cos(q1 - q1L) + ellzcm1*m1*...
                cos(q1 - q1L) + ellzcm4*m4*cos(q1 - q1L) - ellycm1*m1*...
                sin(q1 - q1L) - ellycm4*m4*sin(q1 - q1L));
            D(4,7)=-L4*(L2*m4*cos(q1 - q2L) + ellzcm2*m2*...
                cos(q1 - q2L) + ellzcm3*m3*cos(q1 - q2L) - ellycm2*m2*...
                sin(q1 - q2L) - ellycm3*m3*sin(q1 - q2L));
            D(5,1)=2*L2*m1*cos(q2 + qT) + 2*L2*m2*cos(q2 + qT) + 2*L2*m3*...
                cos(q2 + qT) + L2*m4*cos(q2 + qT) + L2*mT*cos(q2 + qT) - ellzcm2*...
                m2*cos(q2 + qT) - ellzcm3*m3*cos(q2 + qT) - ellycm2*m2*...
                sin(q2 + qT) - ellycm3*m3*sin(q2 + qT);
            D(5,2)=2*L2*m1*sin(q2 + qT) + 2*L2*m2*sin(q2 + qT) + 2*L2*m3*...
                sin(q2 + qT) + L2*m4*sin(q2 + qT) + L2*mT*sin(q2 + qT) + ellycm2*...
                m2*cos(q2 + qT) + ellycm3*m3*cos(q2 + qT) - ellzcm2*m2*...
                sin(q2 + qT) - ellzcm3*m3*sin(q2 + qT);
            D(5,3)=Jcm2 + Jcm3 + 2*L2^2*m1 + 2*L2^2*m2 + 2*L2^2*m3 + L2^2*...
                m4 + L2^2*mT + ellycm2^2*m2 + ellzcm2^2*m2 + ellycm3^2*...
                m3 + ellzcm3^2*m3 - L2^2*m4*cos(q2 - q2L) - 2*L2*ellzcm2*m2 - 2*...
                L2*ellzcm3*m3 - L2*ellzcmT*mT*cos(q2) + L2*ellycmT*mT*...
                sin(q2) - L1*L2*m3*cos(q1 - q2) + 2*L2*L4*m1*cos(q1 - q2) + 2*L2*...
                L4*m2*cos(q1 - q2) + 2*L2*L4*m3*cos(q1 - q2) + L2*L4*m4*...
                cos(q1 - q2) - L1*L2*m3*cos(q2 - q1L) + L2*L4*mT*...
                cos(q1 - q2) - L2*ellzcm1*m1*cos(q1 - q2) + L1*ellzcm3*m3*...
                cos(q1 - q2) - L4*ellzcm2*m2*cos(q1 - q2) - L4*ellzcm3*m3*...
                cos(q1 - q2) - L2*ellzcm1*m1*cos(q2 - q1L) - L2*ellzcm2*m2*...
                cos(q2 - q2L) - L2*ellzcm3*m3*cos(q2 - q2L) - L2*ellzcm4*m4*...
                cos(q2 - q1L) - L2*ellycm1*m1*sin(q1 - q2) - L1*ellycm3*m3*...
                sin(q1 - q2) + L4*ellycm2*m2*sin(q1 - q2) + L4*ellycm3*m3*...
                sin(q1 - q2) + L2*ellycm1*m1*sin(q2 - q1L) + L2*ellycm2*m2*...
                sin(q2 - q2L) + L2*ellycm3*m3*sin(q2 - q2L) + L2*ellycm4*m4*...
                sin(q2 - q1L);
            D(5,4)=2*L2*L4*m1*cos(q1 - q2) - L1*L2*m3*cos(q1 - q2) + 2*L2*L4*...
                m2*cos(q1 - q2) + 2*L2*L4*m3*cos(q1 - q2) + L2*L4*m4*...
                cos(q1 - q2) + L2*L4*mT*cos(q1 - q2) - L2*ellzcm1*m1*...
                cos(q1 - q2) + L1*ellzcm3*m3*cos(q1 - q2) - L4*ellzcm2*m2*...
                cos(q1 - q2) - L4*ellzcm3*m3*cos(q1 - q2) - L2*ellycm1*m1*...
                sin(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L4*ellycm2*m2*...
                sin(q1 - q2) + L4*ellycm3*m3*sin(q1 - q2);
            D(5,5)=Jcm2 + Jcm3 + 2*L2^2*m1 + 2*L2^2*m2 + 2*L2^2*m3 + L2^2*...
                m4 + L2^2*mT + ellycm2^2*m2 + ellzcm2^2*m2 + ellycm3^2*...
                m3 + ellzcm3^2*m3 - 2*L2*ellzcm2*m2 - 2*L2*ellzcm3*m3;
            D(5,6)=-L2*(L1*m3*cos(q2 - q1L) + ellzcm1*m1*...
                cos(q2 - q1L) + ellzcm4*m4*cos(q2 - q1L) - ellycm1*m1*...
                sin(q2 - q1L) - ellycm4*m4*sin(q2 - q1L));
            D(5,7)=L2*ellycm2*m2*sin(q2 - q2L) - L2*ellzcm2*m2*...
                cos(q2 - q2L) - L2*ellzcm3*m3*cos(q2 - q2L) - L2^2*m4*...
                cos(q2 - q2L) + L2*ellycm3*m3*sin(q2 - q2L);
            D(6,1)=- (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
                sin(q1L + qT)))/2 - (m4*(2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
                sin(q1L + qT)))/2 - L1*m3*cos(q1L + qT);
            D(6,2)=(m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
                sin(q1L + qT)))/2 + (m4*(2*ellycm4*cos(q1L + qT) - 2*ellzcm4*...
                sin(q1L + qT)))/2 - L1*m3*sin(q1L + qT);
            D(6,3)=Jcm1 + Jcm4 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 - L1*L2*m3*cos(q2 - q1L) - L1*...
                L4*m3*cos(q1 - q1L) - L2*ellzcm1*m1*cos(q2 - q1L) - L4*ellzcm1*...
                m1*cos(q1 - q1L) - L2*ellzcm4*m4*cos(q2 - q1L) - L4*ellzcm4*m4*...
                cos(q1 - q1L) + L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
                cos(q1L - q2L) + L2*ellycm1*m1*sin(q2 - q1L) + L4*ellycm1*m1*...
                sin(q1 - q1L) + L2*ellycm4*m4*sin(q2 - q1L) + L4*ellycm4*m4*...
                sin(q1 - q1L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(6,4)=-L4*(L1*m3*cos(q1 - q1L) + ellzcm1*m1*...
                cos(q1 - q1L) + ellzcm4*m4*cos(q1 - q1L) - ellycm1*m1*...
                sin(q1 - q1L) - ellycm4*m4*sin(q1 - q1L));
            D(6,5)=-L2*(L1*m3*cos(q2 - q1L) + ellzcm1*m1*...
                cos(q2 - q1L) + ellzcm4*m4*cos(q2 - q1L) - ellycm1*m1*...
                sin(q2 - q1L) - ellycm4*m4*sin(q2 - q1L));
            D(6,6)=Jcm1 + Jcm4 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4;
            D(6,7)=L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
                cos(q1L - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(7,1)=- (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
                sin(q2L + qT)))/2 - (m3*(2*ellzcm3*cos(q2L + qT) + 2*ellycm3*...
                sin(q2L + qT)))/2 - L2*m4*cos(q2L + qT);
            D(7,2)=(m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
                sin(q2L + qT)))/2 + (m3*(2*ellycm3*cos(q2L + qT) - 2*ellzcm3*...
                sin(q2L + qT)))/2 - L2*m4*sin(q2L + qT);
            D(7,3)=Jcm2 + Jcm3 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
                m2 + ellycm3^2*m3 + ellzcm3^2*m3 - L2^2*m4*cos(q2 - q2L) - L2*L4*...
                m4*cos(q1 - q2L) - L2*ellzcm2*m2*cos(q2 - q2L) - L4*ellzcm2*m2*...
                cos(q1 - q2L) - L2*ellzcm3*m3*cos(q2 - q2L) - L4*ellzcm3*m3*...
                cos(q1 - q2L) + L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
                cos(q1L - q2L) + L2*ellycm2*m2*sin(q2 - q2L) + L4*ellycm2*m2*...
                sin(q1 - q2L) + L2*ellycm3*m3*sin(q2 - q2L) + L4*ellycm3*m3*...
                sin(q1 - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(7,4)=-L4*(L2*m4*cos(q1 - q2L) + ellzcm2*m2*...
                cos(q1 - q2L) + ellzcm3*m3*cos(q1 - q2L) - ellycm2*m2*...
                sin(q1 - q2L) - ellycm3*m3*sin(q1 - q2L));
            D(7,5)=L2*ellycm2*m2*sin(q2 - q2L) - L2*ellzcm2*m2*...
                cos(q2 - q2L) - L2*ellzcm3*m3*cos(q2 - q2L) - L2^2*m4*...
                cos(q2 - q2L) + L2*ellycm3*m3*sin(q2 - q2L);
            D(7,6)=L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
                cos(q1L - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(7,7)=Jcm2 + Jcm3 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
                m2 + ellycm3^2*m3 + ellzcm3^2*m3;
            D(8,3)=Jgear1 + Jrotor1*R1;
            D(8,8)=Jgear1 + Jrotor1*R1^2;
            D(9,3)=Jgear2 + Jrotor2*R2;
            D(9,9)=Jgear2 + Jrotor2*R2^2;
            D(10,3)=Jgear1 + Jrotor1*R1;
            D(10,10)=Jgear1 + Jrotor1*R1^2;
            D(11,3)=Jgear2 + Jrotor2*R2;
            D(11,11)=Jgear2 + Jrotor2*R2^2;
            %%%%
            %%%%
            %%%%
            %%%%
            C=zeros(11,11);
            C(1,3)=L1*dq1*m3*sin(q1 + qT) - 2*L2*dq2*m1*sin(q2 + qT) - 2*L4*...
                dq1*m1*sin(q1 + qT) - 2*L2*dq2*m2*sin(q2 + qT) - 2*L4*dq1*m2*...
                sin(q1 + qT) - 2*L2*dq2*m3*sin(q2 + qT) - 2*L4*dq1*m3*...
                sin(q1 + qT) - L2*dq2*m4*sin(q2 + qT) - 2*L4*dq1*m4*...
                sin(q1 + qT) + L1*dq1L*m3*sin(q1L + qT) + L2*dq2L*m4*...
                sin(q2L + qT) + L1*dqT*m3*sin(q1 + qT) - 2*L2*dqT*m1*...
                sin(q2 + qT) - 2*L2*dqT*m2*sin(q2 + qT) - 2*L4*dqT*m1*...
                sin(q1 + qT) - 2*L2*dqT*m3*sin(q2 + qT) - 2*L4*dqT*m2*...
                sin(q1 + qT) - L2*dqT*m4*sin(q2 + qT) - 2*L4*dqT*m3*...
                sin(q1 + qT) - 2*L4*dqT*m4*sin(q1 + qT) + L1*dqT*m3*...
                sin(q1L + qT) + L2*dqT*m4*sin(q2L + qT) - L2*dq2*mT*...
                sin(q2 + qT) - L4*dq1*mT*sin(q1 + qT) - L2*dqT*mT*...
                sin(q2 + qT) - L4*dqT*mT*sin(q1 + qT) - dq1*ellycm1*m1*...
                cos(q1 + qT) - dq2*ellycm2*m2*cos(q2 + qT) - dq1*ellycm4*m4*...
                cos(q1 + qT) - dq2*ellycm3*m3*cos(q2 + qT) - dq1L*ellycm1*m1*...
                cos(q1L + qT) - dq2L*ellycm2*m2*cos(q2L + qT) - dq1L*ellycm4*m4*...
                cos(q1L + qT) - dq2L*ellycm3*m3*cos(q2L + qT) - dqT*ellycm1*m1*...
                cos(q1 + qT) - dqT*ellycm2*m2*cos(q2 + qT) - dqT*ellycm3*m3*...
                cos(q2 + qT) - dqT*ellycm4*m4*cos(q1 + qT) - dqT*ellycm1*m1*...
                cos(q1L + qT) - dqT*ellycm2*m2*cos(q2L + qT) - dqT*ellycm3*m3*...
                cos(q2L + qT) - dqT*ellycm4*m4*cos(q1L + qT) + dq1*ellzcm1*m1*...
                sin(q1 + qT) + dq2*ellzcm2*m2*sin(q2 + qT) + dq1*ellzcm4*m4*...
                sin(q1 + qT) + dq2*ellzcm3*m3*sin(q2 + qT) + dq1L*ellzcm1*m1*...
                sin(q1L + qT) + dq2L*ellzcm2*m2*sin(q2L + qT) + dq1L*ellzcm4*m4*...
                sin(q1L + qT) + dq2L*ellzcm3*m3*sin(q2L + qT) + dqT*ellzcm1*m1*...
                sin(q1 + qT) + dqT*ellzcm2*m2*sin(q2 + qT) + dqT*ellzcm3*m3*...
                sin(q2 + qT) + dqT*ellzcm4*m4*sin(q1 + qT) + dqT*ellzcm1*m1*...
                sin(q1L + qT) + dqT*ellzcm2*m2*sin(q2L + qT) + dqT*ellzcm3*m3*...
                sin(q2L + qT) + dqT*ellzcm4*m4*sin(q1L + qT) - dqT*ellycmT*mT*...
                cos(qT) + dqT*ellzcmT*mT*sin(qT);
            C(1,4)=-(dq1 + dqT)*(2*L4*m1*sin(q1 + qT) - L1*m3*...
                sin(q1 + qT) + 2*L4*m2*sin(q1 + qT) + 2*L4*m3*sin(q1 + qT) + 2*...
                L4*m4*sin(q1 + qT) + L4*mT*sin(q1 + qT) + ellycm1*m1*...
                cos(q1 + qT) + ellycm4*m4*cos(q1 + qT) - ellzcm1*m1*...
                sin(q1 + qT) - ellzcm4*m4*sin(q1 + qT));
            C(1,5)=-(dq2 + dqT)*(2*L2*m1*sin(q2 + qT) + 2*L2*m2*...
                sin(q2 + qT) + 2*L2*m3*sin(q2 + qT) + L2*m4*sin(q2 + qT) + L2*mT*...
                sin(q2 + qT) + ellycm2*m2*cos(q2 + qT) + ellycm3*m3*...
                cos(q2 + qT) - ellzcm2*m2*sin(q2 + qT) - ellzcm3*m3*...
                sin(q2 + qT));
            C(1,6)=(dq1L + dqT)*(L1*m3*sin(q1L + qT) - ellycm1*m1*...
                cos(q1L + qT) - ellycm4*m4*cos(q1L + qT) + ellzcm1*m1*...
                sin(q1L + qT) + ellzcm4*m4*sin(q1L + qT));
            C(1,7)=(dq2L + dqT)*(L2*m4*sin(q2L + qT) - ellycm2*m2*...
                cos(q2L + qT) - ellycm3*m3*cos(q2L + qT) + ellzcm2*m2*...
                sin(q2L + qT) + ellzcm3*m3*sin(q2L + qT));
            C(2,3)=2*L2*dq2*m1*cos(q2 + qT) - L1*dq1*m3*cos(q1 + qT) + 2*L4*...
                dq1*m1*cos(q1 + qT) + 2*L2*dq2*m2*cos(q2 + qT) + 2*L4*dq1*m2*...
                cos(q1 + qT) + 2*L2*dq2*m3*cos(q2 + qT) + 2*L4*dq1*m3*...
                cos(q1 + qT) + L2*dq2*m4*cos(q2 + qT) + 2*L4*dq1*m4*...
                cos(q1 + qT) - L1*dq1L*m3*cos(q1L + qT) - L2*dq2L*m4*...
                cos(q2L + qT) - L1*dqT*m3*cos(q1 + qT) + 2*L2*dqT*m1*...
                cos(q2 + qT) + 2*L2*dqT*m2*cos(q2 + qT) + 2*L4*dqT*m1*...
                cos(q1 + qT) + 2*L2*dqT*m3*cos(q2 + qT) + 2*L4*dqT*m2*...
                cos(q1 + qT) + L2*dqT*m4*cos(q2 + qT) + 2*L4*dqT*m3*...
                cos(q1 + qT) + 2*L4*dqT*m4*cos(q1 + qT) - L1*dqT*m3*...
                cos(q1L + qT) - L2*dqT*m4*cos(q2L + qT) + L2*dq2*mT*...
                cos(q2 + qT) + L4*dq1*mT*cos(q1 + qT) + L2*dqT*mT*...
                cos(q2 + qT) + L4*dqT*mT*cos(q1 + qT) - dq1*ellzcm1*m1*...
                cos(q1 + qT) - dq2*ellzcm2*m2*cos(q2 + qT) - dq1*ellzcm4*m4*...
                cos(q1 + qT) - dq2*ellzcm3*m3*cos(q2 + qT) - dq1L*ellzcm1*m1*...
                cos(q1L + qT) - dq2L*ellzcm2*m2*cos(q2L + qT) - dq1L*ellzcm4*m4*...
                cos(q1L + qT) - dq2L*ellzcm3*m3*cos(q2L + qT) - dqT*ellzcm1*m1*...
                cos(q1 + qT) - dqT*ellzcm2*m2*cos(q2 + qT) - dqT*ellzcm3*m3*...
                cos(q2 + qT) - dqT*ellzcm4*m4*cos(q1 + qT) - dqT*ellzcm1*m1*...
                cos(q1L + qT) - dqT*ellzcm2*m2*cos(q2L + qT) - dqT*ellzcm3*m3*...
                cos(q2L + qT) - dqT*ellzcm4*m4*cos(q1L + qT) - dq1*ellycm1*m1*...
                sin(q1 + qT) - dq2*ellycm2*m2*sin(q2 + qT) - dq1*ellycm4*m4*...
                sin(q1 + qT) - dq2*ellycm3*m3*sin(q2 + qT) - dq1L*ellycm1*m1*...
                sin(q1L + qT) - dq2L*ellycm2*m2*sin(q2L + qT) - dq1L*ellycm4*m4*...
                sin(q1L + qT) - dq2L*ellycm3*m3*sin(q2L + qT) - dqT*ellycm1*m1*...
                sin(q1 + qT) - dqT*ellycm2*m2*sin(q2 + qT) - dqT*ellycm3*m3*...
                sin(q2 + qT) - dqT*ellycm4*m4*sin(q1 + qT) - dqT*ellycm1*m1*...
                sin(q1L + qT) - dqT*ellycm2*m2*sin(q2L + qT) - dqT*ellycm3*m3*...
                sin(q2L + qT) - dqT*ellycm4*m4*sin(q1L + qT) - dqT*ellzcmT*mT*...
                cos(qT) - dqT*ellycmT*mT*sin(qT);
            C(2,4)=-(dq1 + dqT)*(L1*m3*cos(q1 + qT) - 2*L4*m1*...
                cos(q1 + qT) - 2*L4*m2*cos(q1 + qT) - 2*L4*m3*cos(q1 + qT) - 2*...
                L4*m4*cos(q1 + qT) - L4*mT*cos(q1 + qT) + ellzcm1*m1*...
                cos(q1 + qT) + ellzcm4*m4*cos(q1 + qT) + ellycm1*m1*...
                sin(q1 + qT) + ellycm4*m4*sin(q1 + qT));
            C(2,5)=(dq2 + dqT)*(2*L2*m1*cos(q2 + qT) + 2*L2*m2*...
                cos(q2 + qT) + 2*L2*m3*cos(q2 + qT) + L2*m4*cos(q2 + qT) + L2*mT*...
                cos(q2 + qT) - ellzcm2*m2*cos(q2 + qT) - ellzcm3*m3*...
                cos(q2 + qT) - ellycm2*m2*sin(q2 + qT) - ellycm3*m3*...
                sin(q2 + qT));
            C(2,6)=-(dq1L + dqT)*(L1*m3*cos(q1L + qT) + ellzcm1*m1*...
                cos(q1L + qT) + ellzcm4*m4*cos(q1L + qT) + ellycm1*m1*...
                sin(q1L + qT) + ellycm4*m4*sin(q1L + qT));
            C(2,7)=-(dq2L + dqT)*(L2*m4*cos(q2L + qT) + ellzcm2*m2*...
                cos(q2L + qT) + ellzcm3*m3*cos(q2L + qT) + ellycm2*m2*...
                sin(q2L + qT) + ellycm3*m3*sin(q2L + qT));
            C(3,3)=L2^2*dq2*m4*sin(q2 - q2L) - L2^2*dq2L*m4*...
                sin(q2 - q2L) + L2*dq2*ellycmT*mT*cos(q2) + L4*dq1*ellycmT*mT*...
                cos(q1) + L2*dq2*ellzcmT*mT*sin(q2) + L4*dq1*ellzcmT*mT*...
                sin(q1) + L1*L2*dq1*m3*sin(q1 - q2) - L1*L2*dq2*m3*...
                sin(q1 - q2) - 2*L2*L4*dq1*m1*sin(q1 - q2) - 2*L2*L4*dq1*m2*...
                sin(q1 - q2) + 2*L2*L4*dq2*m1*sin(q1 - q2) - 2*L2*L4*dq1*m3*...
                sin(q1 - q2) + 2*L2*L4*dq2*m2*sin(q1 - q2) - L2*L4*dq1*m4*...
                sin(q1 - q2) + 2*L2*L4*dq2*m3*sin(q1 - q2) + L2*L4*dq2*m4*...
                sin(q1 - q2) + L1*L2*dq2*m3*sin(q2 - q1L) + L1*L4*dq1*m3*...
                sin(q1 - q1L) + L2*L4*dq1*m4*sin(q1 - q2L) - L1*L2*dq1L*m3*...
                sin(q2 - q1L) - L1*L4*dq1L*m3*sin(q1 - q1L) - L2*L4*dq2L*m4*...
                sin(q1 - q2L) - L2*L4*dq1*mT*sin(q1 - q2) + L2*L4*dq2*mT*...
                sin(q1 - q2) - L2*dq1*ellycm1*m1*cos(q1 - q2) + L2*dq2*ellycm1*...
                m1*cos(q1 - q2) - L1*dq1*ellycm3*m3*cos(q1 - q2) + L1*dq2*...
                ellycm3*m3*cos(q1 - q2) + L4*dq1*ellycm2*m2*cos(q1 - q2) - L4*...
                dq2*ellycm2*m2*cos(q1 - q2) + L4*dq1*ellycm3*m3*...
                cos(q1 - q2) - L4*dq2*ellycm3*m3*cos(q1 - q2) + L2*dq2*ellycm1*...
                m1*cos(q2 - q1L) + L4*dq1*ellycm1*m1*cos(q1 - q1L) + L2*dq2*...
                ellycm2*m2*cos(q2 - q2L) + L4*dq1*ellycm2*m2*cos(q1 - q2L) + L2*...
                dq2*ellycm3*m3*cos(q2 - q2L) + L4*dq1*ellycm3*m3*...
                cos(q1 - q2L) + L2*dq2*ellycm4*m4*cos(q2 - q1L) + L4*dq1*ellycm4*...
                m4*cos(q1 - q1L) - L2*dq1L*ellycm1*m1*cos(q2 - q1L) - L4*dq1L*...
                ellycm1*m1*cos(q1 - q1L) - L2*dq2L*ellycm2*m2*cos(q2 - q2L) - L4*...
                dq2L*ellycm2*m2*cos(q1 - q2L) - L2*dq1L*ellycm4*m4*...
                cos(q2 - q1L) - L2*dq2L*ellycm3*m3*cos(q2 - q2L) - L4*dq1L*...
                ellycm4*m4*cos(q1 - q1L) - L4*dq2L*ellycm3*m3*cos(q1 - q2L) - L1*...
                dq1L*ellycm3*m3*cos(q1L - q2L) + L1*dq2L*ellycm3*m3*...
                cos(q1L - q2L) + L2*dq1L*ellycm4*m4*cos(q1L - q2L) - L2*dq2L*...
                ellycm4*m4*cos(q1L - q2L) + L2*dq1*ellzcm1*m1*sin(q1 - q2) - L2*...
                dq2*ellzcm1*m1*sin(q1 - q2) - L1*dq1*ellzcm3*m3*...
                sin(q1 - q2) + L1*dq2*ellzcm3*m3*sin(q1 - q2) + L4*dq1*ellzcm2*...
                m2*sin(q1 - q2) - L4*dq2*ellzcm2*m2*sin(q1 - q2) + L4*dq1*...
                ellzcm3*m3*sin(q1 - q2) - L4*dq2*ellzcm3*m3*sin(q1 - q2) + L2*...
                dq2*ellzcm1*m1*sin(q2 - q1L) + L4*dq1*ellzcm1*m1*...
                sin(q1 - q1L) + L2*dq2*ellzcm2*m2*sin(q2 - q2L) + L4*dq1*ellzcm2*...
                m2*sin(q1 - q2L) + L2*dq2*ellzcm3*m3*sin(q2 - q2L) + L4*dq1*...
                ellzcm3*m3*sin(q1 - q2L) + L2*dq2*ellzcm4*m4*sin(q2 - q1L) + L4*...
                dq1*ellzcm4*m4*sin(q1 - q1L) - L2*dq1L*ellzcm1*m1*...
                sin(q2 - q1L) - L4*dq1L*ellzcm1*m1*sin(q1 - q1L) - L2*dq2L*...
                ellzcm2*m2*sin(q2 - q2L) - L4*dq2L*ellzcm2*m2*sin(q1 - q2L) - L2*...
                dq1L*ellzcm4*m4*sin(q2 - q1L) - L2*dq2L*ellzcm3*m3*...
                sin(q2 - q2L) - L4*dq1L*ellzcm4*m4*sin(q1 - q1L) - L4*dq2L*...
                ellzcm3*m3*sin(q1 - q2L) - L1*dq1L*ellzcm3*m3*...
                sin(q1L - q2L) + L1*dq2L*ellzcm3*m3*sin(q1L - q2L) - L2*dq1L*...
                ellzcm4*m4*sin(q1L - q2L) + L2*dq2L*ellzcm4*m4*sin(q1L - q2L);
            C(3,4)=(dq1 + dqT)*(L4*ellycmT*mT*cos(q1) + L4*ellzcmT*mT*...
                sin(q1) + L1*L2*m3*sin(q1 - q2) - 2*L2*L4*m1*sin(q1 - q2) - 2*L2*...
                L4*m2*sin(q1 - q2) - 2*L2*L4*m3*sin(q1 - q2) - L2*L4*m4*...
                sin(q1 - q2) + L1*L4*m3*sin(q1 - q1L) + L2*L4*m4*...
                sin(q1 - q2L) - L2*L4*mT*sin(q1 - q2) - L2*ellycm1*m1*...
                cos(q1 - q2) - L1*ellycm3*m3*cos(q1 - q2) + L4*ellycm2*m2*...
                cos(q1 - q2) + L4*ellycm3*m3*cos(q1 - q2) + L4*ellycm1*m1*...
                cos(q1 - q1L) + L4*ellycm2*m2*cos(q1 - q2L) + L4*ellycm3*m3*...
                cos(q1 - q2L) + L4*ellycm4*m4*cos(q1 - q1L) + L2*ellzcm1*m1*...
                sin(q1 - q2) - L1*ellzcm3*m3*sin(q1 - q2) + L4*ellzcm2*m2*...
                sin(q1 - q2) + L4*ellzcm3*m3*sin(q1 - q2) + L4*ellzcm1*m1*...
                sin(q1 - q1L) + L4*ellzcm2*m2*sin(q1 - q2L) + L4*ellzcm3*m3*...
                sin(q1 - q2L) + L4*ellzcm4*m4*sin(q1 - q1L));
            C(3,5)=(dq2 + dqT)*(L2^2*m4*sin(q2 - q2L) + L2*ellycmT*mT*...
                cos(q2) + L2*ellzcmT*mT*sin(q2) - L1*L2*m3*sin(q1 - q2) + 2*L2*...
                L4*m1*sin(q1 - q2) + 2*L2*L4*m2*sin(q1 - q2) + 2*L2*L4*m3*...
                sin(q1 - q2) + L2*L4*m4*sin(q1 - q2) + L1*L2*m3*...
                sin(q2 - q1L) + L2*L4*mT*sin(q1 - q2) + L2*ellycm1*m1*...
                cos(q1 - q2) + L1*ellycm3*m3*cos(q1 - q2) - L4*ellycm2*m2*...
                cos(q1 - q2) - L4*ellycm3*m3*cos(q1 - q2) + L2*ellycm1*m1*...
                cos(q2 - q1L) + L2*ellycm2*m2*cos(q2 - q2L) + L2*ellycm3*m3*...
                cos(q2 - q2L) + L2*ellycm4*m4*cos(q2 - q1L) - L2*ellzcm1*m1*...
                sin(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) - L4*ellzcm2*m2*...
                sin(q1 - q2) - L4*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm1*m1*...
                sin(q2 - q1L) + L2*ellzcm2*m2*sin(q2 - q2L) + L2*ellzcm3*m3*...
                sin(q2 - q2L) + L2*ellzcm4*m4*sin(q2 - q1L));
            C(3,6)=-(dq1L + dqT)*(L1*L2*m3*sin(q2 - q1L) + L1*L4*m3*...
                sin(q1 - q1L) + L2*ellycm1*m1*cos(q2 - q1L) + L4*ellycm1*m1*...
                cos(q1 - q1L) + L2*ellycm4*m4*cos(q2 - q1L) + L4*ellycm4*m4*...
                cos(q1 - q1L) + L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*m4*...
                cos(q1L - q2L) + L2*ellzcm1*m1*sin(q2 - q1L) + L4*ellzcm1*m1*...
                sin(q1 - q1L) + L2*ellzcm4*m4*sin(q2 - q1L) + L4*ellzcm4*m4*...
                sin(q1 - q1L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            C(3,7)=-(dq2L + dqT)*(L2^2*m4*sin(q2 - q2L) + L2*L4*m4*...
                sin(q1 - q2L) + L2*ellycm2*m2*cos(q2 - q2L) + L4*ellycm2*m2*...
                cos(q1 - q2L) + L2*ellycm3*m3*cos(q2 - q2L) + L4*ellycm3*m3*...
                cos(q1 - q2L) - L1*ellycm3*m3*cos(q1L - q2L) + L2*ellycm4*m4*...
                cos(q1L - q2L) + L2*ellzcm2*m2*sin(q2 - q2L) + L4*ellzcm2*m2*...
                sin(q1 - q2L) + L2*ellzcm3*m3*sin(q2 - q2L) + L4*ellzcm3*m3*...
                sin(q1 - q2L) - L1*ellzcm3*m3*sin(q1L - q2L) - L2*ellzcm4*m4*...
                sin(q1L - q2L));
            C(4,3)=2*L2*L4*dq2*m1*sin(q1 - q2) - L4*dqT*ellzcmT*mT*...
                sin(q1) - L1*L2*dq2*m3*sin(q1 - q2) - L4*dqT*ellycmT*mT*...
                cos(q1) + 2*L2*L4*dq2*m2*sin(q1 - q2) + 2*L2*L4*dq2*m3*...
                sin(q1 - q2) + L2*L4*dq2*m4*sin(q1 - q2) - L1*L4*dq1L*m3*...
                sin(q1 - q1L) - L2*L4*dq2L*m4*sin(q1 - q2L) - L1*L2*dqT*m3*...
                sin(q1 - q2) + 2*L2*L4*dqT*m1*sin(q1 - q2) + 2*L2*L4*dqT*m2*...
                sin(q1 - q2) + 2*L2*L4*dqT*m3*sin(q1 - q2) + L2*L4*dqT*m4*...
                sin(q1 - q2) - L1*L4*dqT*m3*sin(q1 - q1L) - L2*L4*dqT*m4*...
                sin(q1 - q2L) + L2*L4*dq2*mT*sin(q1 - q2) + L2*L4*dqT*mT*...
                sin(q1 - q2) + L2*dq2*ellycm1*m1*cos(q1 - q2) + L1*dq2*ellycm3*...
                m3*cos(q1 - q2) - L4*dq2*ellycm2*m2*cos(q1 - q2) - L4*dq2*...
                ellycm3*m3*cos(q1 - q2) - L4*dq1L*ellycm1*m1*cos(q1 - q1L) - L4*...
                dq2L*ellycm2*m2*cos(q1 - q2L) - L4*dq1L*ellycm4*m4*...
                cos(q1 - q1L) - L4*dq2L*ellycm3*m3*cos(q1 - q2L) + L2*dqT*...
                ellycm1*m1*cos(q1 - q2) + L1*dqT*ellycm3*m3*cos(q1 - q2) - L4*...
                dqT*ellycm2*m2*cos(q1 - q2) - L4*dqT*ellycm3*m3*...
                cos(q1 - q2) - L4*dqT*ellycm1*m1*cos(q1 - q1L) - L4*dqT*ellycm2*...
                m2*cos(q1 - q2L) - L4*dqT*ellycm3*m3*cos(q1 - q2L) - L4*dqT*...
                ellycm4*m4*cos(q1 - q1L) - L2*dq2*ellzcm1*m1*sin(q1 - q2) + L1*...
                dq2*ellzcm3*m3*sin(q1 - q2) - L4*dq2*ellzcm2*m2*...
                sin(q1 - q2) - L4*dq2*ellzcm3*m3*sin(q1 - q2) - L4*dq1L*ellzcm1*...
                m1*sin(q1 - q1L) - L4*dq2L*ellzcm2*m2*sin(q1 - q2L) - L4*dq1L*...
                ellzcm4*m4*sin(q1 - q1L) - L4*dq2L*ellzcm3*m3*sin(q1 - q2L) - L2*...
                dqT*ellzcm1*m1*sin(q1 - q2) + L1*dqT*ellzcm3*m3*...
                sin(q1 - q2) - L4*dqT*ellzcm2*m2*sin(q1 - q2) - L4*dqT*ellzcm3*...
                m3*sin(q1 - q2) - L4*dqT*ellzcm1*m1*sin(q1 - q1L) - L4*dqT*...
                ellzcm2*m2*sin(q1 - q2L) - L4*dqT*ellzcm3*m3*sin(q1 - q2L) - L4*...
                dqT*ellzcm4*m4*sin(q1 - q1L);
            C(4,5)=(dq2 + dqT)*(2*L2*L4*m1*sin(q1 - q2) - L1*L2*m3*...
                sin(q1 - q2) + 2*L2*L4*m2*sin(q1 - q2) + 2*L2*L4*m3*...
                sin(q1 - q2) + L2*L4*m4*sin(q1 - q2) + L2*L4*mT*...
                sin(q1 - q2) + L2*ellycm1*m1*cos(q1 - q2) + L1*ellycm3*m3*...
                cos(q1 - q2) - L4*ellycm2*m2*cos(q1 - q2) - L4*ellycm3*m3*...
                cos(q1 - q2) - L2*ellzcm1*m1*sin(q1 - q2) + L1*ellzcm3*m3*...
                sin(q1 - q2) - L4*ellzcm2*m2*sin(q1 - q2) - L4*ellzcm3*m3*...
                sin(q1 - q2));
            C(4,6)=-L4*(dq1L + dqT)*(L1*m3*sin(q1 - q1L) + ellycm1*m1*...
                cos(q1 - q1L) + ellycm4*m4*cos(q1 - q1L) + ellzcm1*m1*...
                sin(q1 - q1L) + ellzcm4*m4*sin(q1 - q1L));
            C(4,7)=-L4*(dq2L + dqT)*(L2*m4*sin(q1 - q2L) + ellycm2*m2*...
                cos(q1 - q2L) + ellycm3*m3*cos(q1 - q2L) + ellzcm2*m2*...
                sin(q1 - q2L) + ellzcm3*m3*sin(q1 - q2L));
            C(5,3)=L1*L2*dq1*m3*sin(q1 - q2) - L2^2*dqT*m4*...
                sin(q2 - q2L) - L2*dqT*ellycmT*mT*cos(q2) - L2*dqT*ellzcmT*mT*...
                sin(q2) - L2^2*dq2L*m4*sin(q2 - q2L) - 2*L2*L4*dq1*m1*...
                sin(q1 - q2) - 2*L2*L4*dq1*m2*sin(q1 - q2) - 2*L2*L4*dq1*m3*...
                sin(q1 - q2) - L2*L4*dq1*m4*sin(q1 - q2) - L1*L2*dq1L*m3*...
                sin(q2 - q1L) + L1*L2*dqT*m3*sin(q1 - q2) - 2*L2*L4*dqT*m1*...
                sin(q1 - q2) - 2*L2*L4*dqT*m2*sin(q1 - q2) - 2*L2*L4*dqT*m3*...
                sin(q1 - q2) - L2*L4*dqT*m4*sin(q1 - q2) - L1*L2*dqT*m3*...
                sin(q2 - q1L) - L2*L4*dq1*mT*sin(q1 - q2) - L2*L4*dqT*mT*...
                sin(q1 - q2) - L2*dq1*ellycm1*m1*cos(q1 - q2) - L1*dq1*ellycm3*...
                m3*cos(q1 - q2) + L4*dq1*ellycm2*m2*cos(q1 - q2) + L4*dq1*...
                ellycm3*m3*cos(q1 - q2) - L2*dq1L*ellycm1*m1*cos(q2 - q1L) - L2*...
                dq2L*ellycm2*m2*cos(q2 - q2L) - L2*dq1L*ellycm4*m4*...
                cos(q2 - q1L) - L2*dq2L*ellycm3*m3*cos(q2 - q2L) - L2*dqT*...
                ellycm1*m1*cos(q1 - q2) - L1*dqT*ellycm3*m3*cos(q1 - q2) + L4*...
                dqT*ellycm2*m2*cos(q1 - q2) + L4*dqT*ellycm3*m3*...
                cos(q1 - q2) - L2*dqT*ellycm1*m1*cos(q2 - q1L) - L2*dqT*ellycm2*...
                m2*cos(q2 - q2L) - L2*dqT*ellycm3*m3*cos(q2 - q2L) - L2*dqT*...
                ellycm4*m4*cos(q2 - q1L) + L2*dq1*ellzcm1*m1*sin(q1 - q2) - L1*...
                dq1*ellzcm3*m3*sin(q1 - q2) + L4*dq1*ellzcm2*m2*...
                sin(q1 - q2) + L4*dq1*ellzcm3*m3*sin(q1 - q2) - L2*dq1L*ellzcm1*...
                m1*sin(q2 - q1L) - L2*dq2L*ellzcm2*m2*sin(q2 - q2L) - L2*dq1L*...
                ellzcm4*m4*sin(q2 - q1L) - L2*dq2L*ellzcm3*m3*sin(q2 - q2L) + L2*...
                dqT*ellzcm1*m1*sin(q1 - q2) - L1*dqT*ellzcm3*m3*...
                sin(q1 - q2) + L4*dqT*ellzcm2*m2*sin(q1 - q2) + L4*dqT*ellzcm3*...
                m3*sin(q1 - q2) - L2*dqT*ellzcm1*m1*sin(q2 - q1L) - L2*dqT*...
                ellzcm2*m2*sin(q2 - q2L) - L2*dqT*ellzcm3*m3*sin(q2 - q2L) - L2*...
                dqT*ellzcm4*m4*sin(q2 - q1L);
            C(5,4)=-(dq1 + dqT)*(2*L2*L4*m1*sin(q1 - q2) - L1*L2*m3*...
                sin(q1 - q2) + 2*L2*L4*m2*sin(q1 - q2) + 2*L2*L4*m3*...
                sin(q1 - q2) + L2*L4*m4*sin(q1 - q2) + L2*L4*mT*...
                sin(q1 - q2) + L2*ellycm1*m1*cos(q1 - q2) + L1*ellycm3*m3*...
                cos(q1 - q2) - L4*ellycm2*m2*cos(q1 - q2) - L4*ellycm3*m3*...
                cos(q1 - q2) - L2*ellzcm1*m1*sin(q1 - q2) + L1*ellzcm3*m3*...
                sin(q1 - q2) - L4*ellzcm2*m2*sin(q1 - q2) - L4*ellzcm3*m3*...
                sin(q1 - q2));
            C(5,6)=-L2*(dq1L + dqT)*(L1*m3*sin(q2 - q1L) + ellycm1*m1*...
                cos(q2 - q1L) + ellycm4*m4*cos(q2 - q1L) + ellzcm1*m1*...
                sin(q2 - q1L) + ellzcm4*m4*sin(q2 - q1L));
            C(5,7)=-L2*(dq2L + dqT)*(L2*m4*sin(q2 - q2L) + ellycm2*m2*...
                cos(q2 - q2L) + ellycm3*m3*cos(q2 - q2L) + ellzcm2*m2*...
                sin(q2 - q2L) + ellzcm3*m3*sin(q2 - q2L));
            C(6,3)=L1*L2*dq2*m3*sin(q2 - q1L) + L1*L4*dq1*m3*...
                sin(q1 - q1L) + L1*L2*dqT*m3*sin(q2 - q1L) + L1*L4*dqT*m3*...
                sin(q1 - q1L) + L2*dq2*ellycm1*m1*cos(q2 - q1L) + L4*dq1*ellycm1*...
                m1*cos(q1 - q1L) + L2*dq2*ellycm4*m4*cos(q2 - q1L) + L4*dq1*...
                ellycm4*m4*cos(q1 - q1L) + L1*dq2L*ellycm3*m3*...
                cos(q1L - q2L) - L2*dq2L*ellycm4*m4*cos(q1L - q2L) + L2*dqT*...
                ellycm1*m1*cos(q2 - q1L) + L4*dqT*ellycm1*m1*cos(q1 - q1L) + L2*...
                dqT*ellycm4*m4*cos(q2 - q1L) + L4*dqT*ellycm4*m4*...
                cos(q1 - q1L) + L1*dqT*ellycm3*m3*cos(q1L - q2L) - L2*dqT*...
                ellycm4*m4*cos(q1L - q2L) + L2*dq2*ellzcm1*m1*sin(q2 - q1L) + L4*...
                dq1*ellzcm1*m1*sin(q1 - q1L) + L2*dq2*ellzcm4*m4*...
                sin(q2 - q1L) + L4*dq1*ellzcm4*m4*sin(q1 - q1L) + L1*dq2L*...
                ellzcm3*m3*sin(q1L - q2L) + L2*dq2L*ellzcm4*m4*...
                sin(q1L - q2L) + L2*dqT*ellzcm1*m1*sin(q2 - q1L) + L4*dqT*...
                ellzcm1*m1*sin(q1 - q1L) + L2*dqT*ellzcm4*m4*sin(q2 - q1L) + L4*...
                dqT*ellzcm4*m4*sin(q1 - q1L) + L1*dqT*ellzcm3*m3*...
                sin(q1L - q2L) + L2*dqT*ellzcm4*m4*sin(q1L - q2L);
            C(6,4)=L4*(dq1 + dqT)*(L1*m3*sin(q1 - q1L) + ellycm1*m1*...
                cos(q1 - q1L) + ellycm4*m4*cos(q1 - q1L) + ellzcm1*m1*...
                sin(q1 - q1L) + ellzcm4*m4*sin(q1 - q1L));
            C(6,5)=L2*(dq2 + dqT)*(L1*m3*sin(q2 - q1L) + ellycm1*m1*...
                cos(q2 - q1L) + ellycm4*m4*cos(q2 - q1L) + ellzcm1*m1*...
                sin(q2 - q1L) + ellzcm4*m4*sin(q2 - q1L));
            C(6,7)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            C(7,3)=L2^2*dq2*m4*sin(q2 - q2L) + L2^2*dqT*m4*...
                sin(q2 - q2L) + L2*L4*dq1*m4*sin(q1 - q2L) + L2*L4*dqT*m4*...
                sin(q1 - q2L) + L2*dq2*ellycm2*m2*cos(q2 - q2L) + L4*dq1*ellycm2*...
                m2*cos(q1 - q2L) + L2*dq2*ellycm3*m3*cos(q2 - q2L) + L4*dq1*...
                ellycm3*m3*cos(q1 - q2L) - L1*dq1L*ellycm3*m3*...
                cos(q1L - q2L) + L2*dq1L*ellycm4*m4*cos(q1L - q2L) + L2*dqT*...
                ellycm2*m2*cos(q2 - q2L) + L4*dqT*ellycm2*m2*cos(q1 - q2L) + L2*...
                dqT*ellycm3*m3*cos(q2 - q2L) + L4*dqT*ellycm3*m3*...
                cos(q1 - q2L) - L1*dqT*ellycm3*m3*cos(q1L - q2L) + L2*dqT*...
                ellycm4*m4*cos(q1L - q2L) + L2*dq2*ellzcm2*m2*sin(q2 - q2L) + L4*...
                dq1*ellzcm2*m2*sin(q1 - q2L) + L2*dq2*ellzcm3*m3*...
                sin(q2 - q2L) + L4*dq1*ellzcm3*m3*sin(q1 - q2L) - L1*dq1L*...
                ellzcm3*m3*sin(q1L - q2L) - L2*dq1L*ellzcm4*m4*...
                sin(q1L - q2L) + L2*dqT*ellzcm2*m2*sin(q2 - q2L) + L4*dqT*...
                ellzcm2*m2*sin(q1 - q2L) + L2*dqT*ellzcm3*m3*sin(q2 - q2L) + L4*...
                dqT*ellzcm3*m3*sin(q1 - q2L) - L1*dqT*ellzcm3*m3*...
                sin(q1L - q2L) - L2*dqT*ellzcm4*m4*sin(q1L - q2L);
            C(7,4)=L4*(dq1 + dqT)*(L2*m4*sin(q1 - q2L) + ellycm2*m2*...
                cos(q1 - q2L) + ellycm3*m3*cos(q1 - q2L) + ellzcm2*m2*...
                sin(q1 - q2L) + ellzcm3*m3*sin(q1 - q2L));
            C(7,5)=L2*(dq2 + dqT)*(L2*m4*sin(q2 - q2L) + ellycm2*m2*...
                cos(q2 - q2L) + ellycm3*m3*cos(q2 - q2L) + ellzcm2*m2*...
                sin(q2 - q2L) + ellzcm3*m3*sin(q2 - q2L));
            C(7,6)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            %%%%
            %%%%
            %%%%
            %%%%
            G=zeros(11,1);
            G(1)=0;
            G(2)=g*(2*m1 + 2*m2 + 2*m3 + 2*m4 + mT);
            G(3)=g*(ellycmT*mT*cos(qT) - ellzcmT*mT*sin(qT) - L1*m3*...
                sin(q1 + qT) + 2*L2*m1*sin(q2 + qT) + 2*L2*m2*sin(q2 + qT) + 2*...
                L4*m1*sin(q1 + qT) + 2*L2*m3*sin(q2 + qT) + 2*L4*m2*...
                sin(q1 + qT) + L2*m4*sin(q2 + qT) + 2*L4*m3*sin(q1 + qT) + 2*L4*...
                m4*sin(q1 + qT) - L1*m3*sin(q1L + qT) - L2*m4*sin(q2L + qT) + L2*...
                mT*sin(q2 + qT) + L4*mT*sin(q1 + qT) + ellycm1*m1*...
                cos(q1 + qT) + ellycm2*m2*cos(q2 + qT) + ellycm3*m3*...
                cos(q2 + qT) + ellycm4*m4*cos(q1 + qT) + ellycm1*m1*...
                cos(q1L + qT) + ellycm2*m2*cos(q2L + qT) + ellycm3*m3*...
                cos(q2L + qT) + ellycm4*m4*cos(q1L + qT) - ellzcm1*m1*...
                sin(q1 + qT) - ellzcm2*m2*sin(q2 + qT) - ellzcm3*m3*...
                sin(q2 + qT) - ellzcm4*m4*sin(q1 + qT) - ellzcm1*m1*...
                sin(q1L + qT) - ellzcm2*m2*sin(q2L + qT) - ellzcm3*m3*...
                sin(q2L + qT) - ellzcm4*m4*sin(q1L + qT));
            G(4)=g*(2*L4*m1*sin(q1 + qT) - L1*m3*sin(q1 + qT) + 2*L4*m2*...
                sin(q1 + qT) + 2*L4*m3*sin(q1 + qT) + 2*L4*m4*sin(q1 + qT) + L4*...
                mT*sin(q1 + qT) + ellycm1*m1*cos(q1 + qT) + ellycm4*m4*...
                cos(q1 + qT) - ellzcm1*m1*sin(q1 + qT) - ellzcm4*m4*...
                sin(q1 + qT)) + (K1*(2*q1 - 2*qgr1))/2;
            G(5)=g*(2*L2*m1*sin(q2 + qT) + 2*L2*m2*sin(q2 + qT) + 2*L2*m3*...
                sin(q2 + qT) + L2*m4*sin(q2 + qT) + L2*mT*sin(q2 + qT) + ellycm2*...
                m2*cos(q2 + qT) + ellycm3*m3*cos(q2 + qT) - ellzcm2*m2*...
                sin(q2 + qT) - ellzcm3*m3*sin(q2 + qT)) + (K2*(2*q2 - 2*qgr2))/2;
            G(6)=(K1*(2*q1L - 2*qgr1L))/2 - g*(L1*m3*sin(q1L + qT) - ellycm1*...
                m1*cos(q1L + qT) - ellycm4*m4*cos(q1L + qT) + ellzcm1*m1*...
                sin(q1L + qT) + ellzcm4*m4*sin(q1L + qT));
            G(7)=(K2*(2*q2L - 2*qgr2L))/2 - g*(L2*m4*sin(q2L + qT) - ellycm2*...
                m2*cos(q2L + qT) - ellycm3*m3*cos(q2L + qT) + ellzcm2*m2*...
                sin(q2L + qT) + ellzcm3*m3*sin(q2L + qT));
            G(8)=-K1*(q1 - qgr1);
            G(9)=-K2*(q2 - qgr2);
            G(10)=-K1*(q1L - qgr1L);
            G(11)=-K2*(q2L - qgr2L);
            %%%%
            %%%%
            %%%%
            %%%%
            B=zeros(11,4);
            B(8,1)=R1;
            B(9,2)=R2;
            B(10,3)=R1;
            B(11,4)=R2;
            %%%%
            %%%%
            DampingSpringTorque=zeros(11,1);
            DampingSpringTorque(1)=0;
            DampingSpringTorque(2)=0;
            DampingSpringTorque(3)=0;
            DampingSpringTorque(4)=Kd1*(dq1 - dqgr1);
            DampingSpringTorque(5)=Kd2*(dq2 - dqgr2);
            DampingSpringTorque(6)=Kd1*(dq1L - dqgr1L);
            DampingSpringTorque(7)=Kd2*(dq2L - dqgr2L);
            DampingSpringTorque(8)=-Kd1*(dq1 - dqgr1);
            DampingSpringTorque(9)=-Kd2*(dq2 - dqgr2);
            DampingSpringTorque(10)=-Kd1*(dq1L - dqgr1L);
            DampingSpringTorque(11)=-Kd2*(dq2L - dqgr2L);
            
        end
        function [Ds,Cs,Gs,Bs,DampingSpringTorque_s]=shrink_model(obj,q,dq)
            [D,C,G,B,DampingSpringTorque]= obj.Dynamic_model(q,dq);
            Ds=D(3:end,3:end);
            Cs=C(3:end,3:end);
            Gs=G(3:end);
            DampingSpringTorque_s=DampingSpringTorque(3:end);
            Bs=B(3:end,:);
 
        end
        function [D_hat,C_hat,Omega_hat,B2]=get_PBC_part(obj,q,dq)
                        [Ds,Cs,Gs,Bs]=obj.shrink_model(q,dq);
                        qu=q(3:7);    dqu=dq(3:7);
                        qa=q(8:11);  dqa=dq(8:11);
            
                        D11=Ds(1:5,1:5);
                        D12=Ds(1:5,6:9);
                        D21=Ds(6:9,1:5);
                        D22=Ds(6:9,6:9);

                        C11=Cs(1:5,1:5);
                        C12=Cs(1:5,6:9);
                        C21=Cs(6:9,1:5);
                        C22=Cs(6:9,6:9);

                        G1=Gs(1:5);
                        G2=Gs(6:9);
            
                        B2=Bs(6:9,:);
            
                        Omega1=C11*dqu+C12*dqa+G1;
                        Omega2=C21*dqu+C22*dqa+G2;
            
                        D_hat=(D22-D21*D11^-1*D12);
                        Omega_hat=-D21*D11^-1*Omega1+Omega2;
                        A1=C22-C21*D11^-1*D12;
                        A2=-C12'*D11^-1*D12;
                        A3=D21*D11^-1*C11*D11^-1*D12;
                        C_hat=A1+A2+A3;
        end
        function [pT,pHip,p1R,p2R,p3R,p4R,p1L,p2L,p3L,p4L]=get_joint_position(obj,x)
            L1=obj.L1;    L3=obj.L3;    LT=obj.LT;
            L2=obj.L2;    L4=obj.L4;
            
            yLeg=x(1);
            zLeg=x(2);
            qT=x(3);
            q1R=x(4);
            q2R=x(5);
            q1L=x(6);
            q2L=x(7);
            
%             q1R=x(8);
%             q2R=x(9);
%             q1L=x(10);
%             q2L=x(11);
%             
            th1R=qT+q1R;
            th2R=qT+q2R;
            th1L=qT+q1L;
            th2L=qT+q2L;
            
            p4R=[yLeg;zLeg];
            p3R=p4R-obj.R(th1R)*[0;(L4-L1)];
            p2R=p4R-obj.R(th1R)*[0;L4];
            p1R=p3R-obj.R(th2R)*[0;L3];
            
            pHip=p1R-obj.R(th1R)*[0;L1];
            
            p1L=pHip+obj.R(th1L)*[0;L1];
            p2L=pHip+obj.R(th2L)*[0;L2];
            p3L=p1L+obj.R(th2L)*[0;L3];
            p4L=p2L+obj.R(th1L)*[0;L4];
            % PmL=p2L+R(th1L)*[0;L1];
            
            pT=pHip+obj.R(qT)*[0;LT];
        end
        function [p1Rm,p2Rm,p3Rm,p4Rm,p1Lm,p2Lm,p3Lm,p4Lm]=get_motor_joint_position(obj,x)
            [~,pHip,~,~,~,~,~,~,~,~]=obj.get_joint_position(x);
            
            L1=obj.L1;    L3=obj.L3;    LT=obj.LT;
            L2=obj.L2;    L4=obj.L4;
            

            qT=x(3);
            
            %The angle of the shafts not the links
            q1Rm=x(8);
            q2Rm=x(9);
            q1Lm=x(10);
            q2Lm=x(11);
             
            th1Rm=qT+q1Rm;
            th2Rm=qT+q2Rm;
            th1Lm=qT+q1Lm;
            th2Lm=qT+q2Lm;
            
            p1Rm=pHip+obj.R(th1Rm)*[0;L1];
            p2Rm=pHip+obj.R(th2Rm)*[0;L2];
            p3Rm=p1Rm+obj.R(th2Rm)*[0;L3];
            p4Rm=p2Rm+obj.R(th1Rm)*[0;L4];

            p1Lm=pHip+obj.R(th1Lm)*[0;L1];
            p2Lm=pHip+obj.R(th2Lm)*[0;L2];
            p3Lm=p1Lm+obj.R(th2Lm)*[0;L3];
            p4Lm=p2Lm+obj.R(th1Lm)*[0;L4];
            % PmL=p2L+R(th1L)*[0;L1];
            

        end
        function Rotation_matrix=R(obj,x)
            Rotation_matrix=[cos(x),-sin(x);sin(x),cos(x)];
        end
        function [ER,dER]=get_ER(obj,x)
            L1=obj.L1;  L2=obj.L2;  L3=obj.L3;  L4=obj.L4;
            q=x(1:11);   dq=x(12:22);
            yLeg=q(1);  dyLeg=dq(1);
            zLeg=q(2);  dzLeg=dq(2);
            qT=q(3);  dqT=dq(3);
            q1R=q(4);  dq1R=dq(4);
            q2R=q(5);  dq2R=dq(5);
            q1L=q(6);  dq1L=dq(6);
            q2L=q(7);  dq2L=dq(7);
            ER=[ 1, 0
                0, 1
                0, 0
                0, 0
                0, 0
                0, 0
                0, 0
                0, 0
                0, 0
                0, 0
                0, 0];
            ER=ER';
            dER=[ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        end
        function [EL,dEL]=get_EL(obj,x)
            L1=obj.L1;  L2=obj.L2;  L3=obj.L3;  L4=obj.L4;
            q=x(1:11);   dq=x(12:22);
            yLeg=q(1);  dyLeg=dq(1);
            zLeg=q(2);  dzLeg=dq(2);
            qT=q(3);  dqT=dq(3);
            q1R=q(4);  dq1R=dq(4);
            q2R=q(5);  dq2R=dq(5);
            q1L=q(6);  dq1L=dq(6);
            q2L=q(7);  dq2L=dq(7);
            
            EL=[                                                                  1,                                                                       0
                0,                                                                       1
                L2*cos(q2R + qT) + L4*cos(q1R + qT) - L2*cos(q2L + qT) - L4*cos(q1L + qT), L2*sin(q2R + qT) + L4*sin(q1R + qT) - L2*sin(q2L + qT) - L4*sin(q1L + qT)
                L4*cos(q1R + qT),                                                         L4*sin(q1R + qT)
                L2*cos(q2R + qT),                                                         L2*sin(q2R + qT)
                -L4*cos(q1L + qT),                                                       -L4*sin(q1L + qT)
                -L2*cos(q2L + qT),                                                       -L2*sin(q2L + qT)
                0,                                                                       0
                0,                                                                       0
                0,                                                                       0
                0,                                                                       0];
            EL=EL';
           dEL=[ 0, 0, dqT*(L2*sin(q2L + qT) + L4*sin(q1L + qT) - L2*sin(q2R + qT) - L4*sin(q1R + qT)) + L2*dq2L*sin(q2L + qT) + L4*dq1L*sin(q1L + qT) - L2*dq2R*sin(q2R + qT) - L4*dq1R*sin(q1R + qT), - L4*dq1R*sin(q1R + qT) - L4*dqT*sin(q1R + qT), - L2*dq2R*sin(q2R + qT) - L2*dqT*sin(q2R + qT),   L4*dq1L*sin(q1L + qT) + L4*dqT*sin(q1L + qT),   L2*dq2L*sin(q2L + qT) + L2*dqT*sin(q2L + qT), 0, 0, 0, 0
                 0, 0, L2*dq2R*cos(q2R + qT) - L2*dq2L*cos(q2L + qT) - L4*dq1L*cos(q1L + qT) - dqT*(L2*cos(q2L + qT) + L4*cos(q1L + qT) - L2*cos(q2R + qT) - L4*cos(q1R + qT)) + L4*dq1R*cos(q1R + qT),   L4*dq1R*cos(q1R + qT) + L4*dqT*cos(q1R + qT),   L2*dq2R*cos(q2R + qT) + L2*dqT*cos(q2R + qT), - L4*dq1L*cos(q1L + qT) - L4*dqT*cos(q1L + qT), - L2*dq2L*cos(q2L + qT) - L2*dqT*cos(q2L + qT), 0, 0, 0, 0];   
        end
        function value=get.mTotal(obj)
            value = 2*(obj.m1 + obj.m2 + obj.m3 + obj.m4) + obj.mT + obj.mH;
        end
        function value=get.K1(obj)
            value = 0.85*obj.KJonathan;
        end
        function value=get.K2(obj)
            value = 1.1*obj.KJonathan;
        end
        function value=get.Kd1(obj)
            value = 2*obj.Zeta*sqrt(obj.K1);
        end
        function value=get.Kd2(obj)
            value = 2*obj.Zeta*sqrt(obj.K2);
        end
    end
end



